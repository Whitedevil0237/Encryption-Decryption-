<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AES-GCM Encryption/Decryption</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #0f172a;
      color: #f8fafc;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: #1e293b;
      padding: 2rem;
      border-radius: 1rem;
      width: 360px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }
    h2 {
      text-align: center;
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-top: 0.75rem;
    }
    input, textarea {
      width: 100%;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: none;
      outline: none;
      margin-top: 0.3rem;
      background: #334155;
      color: white;
    }
    button {
      width: 48%;
      margin-top: 1rem;
      padding: 0.6rem;
      border: none;
      border-radius: 0.5rem;
      background: #2563eb;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #1d4ed8;
    }
    .btn-row {
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>AES-GCM Tool</h2>
    <label>Enter Text:</label>
    <textarea id="inputText" rows="2" placeholder="Enter text to encrypt or decrypt"></textarea>

    <label>Key:</label>
    <input type="text" id="keyInput" placeholder="Enter secret key" />

    <label>Result (Base64):</label>
    <textarea id="resultText" rows="2" readonly></textarea>

    <div class="btn-row">
      <button onclick="encryptText()">Encrypt</button>
      <button onclick="decryptText()">Decrypt</button>
    </div>
  </div>

  <script>
    async function getKeyFromPassword(password) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw",
        enc.encode(password),
        "PBKDF2",
        false,
        ["deriveKey"]
      );
      const key = await crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt: new TextEncoder().encode("aes-gcm-salt"),
          iterations: 100000,
          hash: "SHA-256",
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        true,
        ["encrypt", "decrypt"]
      );
      return key;
    }

    function bufferToBase64(buf) {
      return btoa(String.fromCharCode(...new Uint8Array(buf)));
    }

    function base64ToBuffer(base64) {
      return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
    }

    async function encryptText() {
      const text = document.getElementById("inputText").value;
      const password = document.getElementById("keyInput").value;
      if (!text || !password) return alert("Enter both text and key!");

      const key = await getKeyFromPassword(password);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const enc = new TextEncoder();
      const encoded = enc.encode(text);

      const ciphertext = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        key,
        encoded
      );

      const combined = new Uint8Array(iv.length + ciphertext.byteLength);
      combined.set(iv);
      combined.set(new Uint8Array(ciphertext), iv.length);

      const base64 = bufferToBase64(combined);
      document.getElementById("resultText").value = base64;
    }

    async function decryptText() {
      const base64 = document.getElementById("inputText").value.trim();
      const password = document.getElementById("keyInput").value;
      if (!base64 || !password) return alert("Enter both Base64 text and key!");

      const key = await getKeyFromPassword(password);
      const data = base64ToBuffer(base64);
      const iv = data.slice(0, 12);
      const ciphertext = data.slice(12);

      try {
        const decrypted = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv },
          key,
          ciphertext
        );

        const dec = new TextDecoder().decode(decrypted);
        // show decrypted message in Result field
        document.getElementById("resultText").value = dec;
      } catch (e) {
        document.getElementById("resultText").value = "‚ùå Decryption failed: Wrong key or data!";
      }
    }
  </script>
</body>
</html>
